// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Nonce {
  id        String   @id @default(cuid())
  nonce     String   @unique
  address   String
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([nonce])
  @@index([address])
}

model WalletLink {
  id                String      @id @default(cuid())
  solanaAddress     String
  evmAddress        String
  tokenIds          String      // JSON string of NFT token IDs (legacy, kept for compatibility)
  solanaSignature   String
  evmSignature      String
  verifiedAt        DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relation to linked NFTs
  linkedNFTs        LinkedNFT[]

  @@unique([solanaAddress, evmAddress])
  @@index([solanaAddress])
  @@index([evmAddress])
}

model LinkedNFT {
  id                String      @id @default(cuid())
  tokenId           String      // Token ID (e.g., "564")
  mintAddress       String      // The actual NFT mint address
  solanaAddress     String      // Wallet that owns this NFT
  evmAddress        String      // Linked EVM wallet
  walletLinkId      String      // Reference to the WalletLink
  linkedAt          DateTime    @default(now())
  
  // Relation back to WalletLink
  walletLink        WalletLink  @relation(fields: [walletLinkId], references: [id], onDelete: Cascade)

  @@unique([tokenId]) // Token IDs can only be linked ONCE globally - prevents relinking sold/transferred NFTs
  @@unique([mintAddress, evmAddress]) // One mint address can only be linked to one EVM address (but can be relinked if sold to new wallet)
  @@index([tokenId])
  @@index([solanaAddress])
  @@index([evmAddress])
  @@index([walletLinkId])
}

